{% extends "../layout.html" %}

{% block styles %}
	<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.18.1/vis.min.css" rel="stylesheet">
	<style>
		#rod_tree {
			height: 600px;
			border: 1px solid lightgray;
		}
	</style>
{% endblock %}

{% block title %} {{person.fullname}} {% endblock %}

{% block content %}
	<h2>{{person.fullname}}</h2>
	<p>{{person.lifestory}}</p>

	{#{% if person.rods.length %}
		<p>Род:
		{% for rod in person.rods %}<a href="/rod/{{rod.key}}">{{rod.name}} {% endfor %}</a>
		</p>
	{% endif %}#}

	{% if person.rod %}
		<p>Род: <a href="/rod/{{person.rod.key}}">{{person.rod.name}}</a></p>
	{% endif %}

	<p>Год рождения: {{person.born}}</p>
	<p>Добавил: <a href="/person/{{person.addedBy.key}}">{{person.addedBy.name}}</a></p>

	{% if person.gender == 0 %}
		<p>Девичья фамилия: {{person.maidenName}}</p>
	{% endif %}

	<br>
	<p> <!-- todo: проработать права на добавление -->
		Добавить
		<a href="/person/{{person._key}}/add/father">отца</a> |
		<a href="/person/{{person._key}}/add/mother">мать</a> |
		<a href="/person/{{person._key}}/add/son">сына</a> |
		<a href="/person/{{person._key}}/add/daughter">дочь</a>
	</p>

	<h3>Предки</h3>
	<ul id="ancestors">
		{% for a in ancestors %}
		<li><a href="/person/{{a.person._key}}">{{ a.person.fullname }}</a>, {{ a | ancestorRelation }}</li>
		{% endfor %}
	</ul>

	<h3>Потомки</h3>
	<ul id="descendants">
		{% for d in descendants %}
		<li><a href="/person/{{d.person._key}}">{{ d.person.fullname }}</a>, {{ d | descendantRelation }}</li>
		{% endfor %}
	</ul>

	<a href="/person/{{person._key}}/remove">Удалить персону</a>
	<br/>
	<br/>
	<div id="rod_tree" ></div>
{% endblock %}

{% block scripts %}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.18.1/vis.min.js"></script>

	<script>
        let container = document.getElementById('rod_tree');
        let net_data = {nodes: [], edges: []};

        // provide the data in the vis format
        let options = {
            layout: {
                hierarchical: {
                    sortMethod: "directed"
                }
            },
            edges: {
                smooth: true,
                arrows: {to : true }
            }
        };

		let xhr = new XMLHttpRequest();
		window.onload = function () {
		    xhr.open("GET", "/ajax/get_anc_des/{{person._key}}", true);
		    xhr.send();
            xhr.onreadystatechange = function() {
                if (xhr.readyState != 4) return;
                if (xhr.status != 200) {
                    alert(xhr.status + ': ' + xhr.statusText);
                } else {
                    let result = JSON.parse(xhr.responseText);
                    // prepare net_data
                    net_data.nodes.push({id: result.person._id, label: result.person.fullname});

                    result.ancestors.map(item => {
                        net_data.nodes.push({id: item.person._id, label: item.person.fullname});
                        net_data.edges.push({from: item.edge._from, to: item.edge._to});
					});

                    result.descendants.map(item => {
                        net_data.nodes.push({id: item.person._id, label: item.person.fullname});
                        net_data.edges.push({from: item.edge._from, to: item.edge._to});
					});
                    // initialize your network!
                    let network = new vis.Network(container, net_data, options);
                }

            }
        };
	</script>
{% endblock %}