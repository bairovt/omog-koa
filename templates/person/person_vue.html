{% extends "../layout.html" %}

{% block styles %}
	<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.18.1/vis.min.css" rel="stylesheet">
	<style>
		#rod_tree {
			height: 800px;
			/*border: 1px solid lightgray;*/
		}
	</style>
{% endblock %}

{% block title %} {{person.surname}} {{person.name}} {% endblock %}

{% block content %}
	<div class="row">
		<div class="col-md-8">
			<div id="rod_tree" ></div>
		</div>
		<div class="col-md-4" id="person-profile"></div>
	</div>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.18.1/vis.min.js"></script>

<script type="text/x-template" id="person-profile-template">
	<div>
		<h3>{{person.surname}} {{person.name}} {{person.midname}}</h3>
		<p>{{person.lifestory}}</p>
		<p v-if="person.rod">Род: <a href="/rod/{{person.rod.key}}">{{person.rod.name}}</a></p>
		<p>Год рождения: {{person.born}}</p>
		<p>Добавил: <a href="/person/{{person.addedBy.key}}">{{person.addedBy.surname}} {{person.addedBy.name}}</a></p>
		<p>id: {{person._key}}</p>
		<p v-if="person.gender == 0">Девичья фамилия: {{person.maidenName}}</p>
		<br>
		<p> <!-- todo: проработать права на добавление -->
			Добавить
			<a href="/person/{{person._key}}/add/father">отца</a> |
			<a href="/person/{{person._key}}/add/mother">мать</a> |
			<a href="/person/{{person._key}}/add/son">сына</a> |
			<a href="/person/{{person._key}}/add/daughter">дочь</a>
		</p>
		<p> <!-- todo: проработать права на указание -->
			Указать
			<a href="/person/{{person._key}}/link/father">отца</a> |
			<a href="/person/{{person._key}}/link/mother">мать</a> |
			<a href="/person/{{person._key}}/link/son">сына</a> |
			<a href="/person/{{person._key}}/link/daughter">дочь</a>
		</p>
		<h3>Предки</h3>
		<ul id="ancestors">
			{% for a in ancestors %}
			<li><a href="/person/{{a.person._key}}">{{a.person.surname}} {{a.person.name}} {{a.person.midname}}</a> {{ a | ancestorRelation }}</li>
			{% endfor %}
		</ul>

		<h3>Потомки</h3>
		<ul id="descendants">
			{% for d in descendants %}
			<li><a href="/person/{{d.person._key}}">{{d.person.surname}}  {{ d.person.name }}</a> {{ d | descendantRelation }}</li>
			{% endfor %}
		</ul>

		<!--<a href="/person/{{person._key}}/edit">Изменить персону</a><br/><br/>-->
		<a href="/person/{{person._key}}/remove">Удалить персону</a>
	</div>
</script>

	<script>
		var app = new Vue({
			el: "#person-profile",
			data: {
			  person: 'sdf'//{name: 'проверка'}
			},
      template: "<h3>Персона {{person}}: {{ person.surname }} {{ person.name }} {{ person.midname }}</h3>",
//      mounted: function () {
//			  let vm = this;
//        axios.get('/api/get-anc-des/{{person_key}}')
//            .then(function (resp) {
////              console.log(resp.data.person);
//	            vm.person = resp.data.person;
//            });
//      }
		});

    let visContainer = document.getElementById('rod_tree');
    let visData = {nodes: [], edges: []};

    // provide the data in the vis format
    let options = {
      layout: {
        hierarchical: {
          sortMethod: "directed"
        }
      },
      edges: {
        smooth: true,
        arrows: {to : true }
      }
    };

		window.onload = function () {
      axios.get("/api/get-anc-des/{{person_key}}")
	      .then(function (resp) {
	        var person = resp.data.person;
	        var ancestors = resp.data.ancestors;
	        var descendants = resp.data.descendants;

          // prepare visData
          visData.nodes.push({id: person_vue._id, label: `${person_vue.surname} ${person_vue.name}`});

          ancestors.map(item => {
            visData.nodes.push({id: item.person._id, label: `${item.person.surname} ${item.person.name}`});
            visData.edges.push({from: item.edge._from, to: item.edge._to});
					});

          descendants.map(item => {
            visData.nodes.push({id: item.person._id, label: `${item.person.surname} ${item.person.name}`});
            visData.edges.push({from: item.edge._from, to: item.edge._to});
					});
          // initialize your network!
          var network = new vis.Network(visContainer, visData, options);
        })
    }
	</script>
{% endblock %}